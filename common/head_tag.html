<script type="module">
  import Keycloak from "https://cdn.jsdelivr.net/npm/keycloak-js@26.0.5/lib/keycloak.js";
  const keycloak = new Keycloak({
    url: "https://hub.earthcode.eox.at/auth",
    realm: "nebari",
    clientId: "discourse",
  });
  if (window.location.href !== "/login" && window.location.href === "/session/sso") {
    try {
      const authenticated = await keycloak.init({
        onLoad: "check-sso",
        checkLoginIframe: false,
      });
      if (authenticated) {
        console.log("User is authenticated in EarthCODE");
        const currentSession = await fetch("/session/current.json")
        if (currentSession.ok) {
          console.log("User is authenticated in Discourse");
        } else {
          console.log("User is not authenticated in Discourse. Redirecting...");
          // window.location.href = "/login"
          window.location.href = "/session/sso"
        }
      } else {
        console.log("User is not authenticated in EarthCODE");
      }
    } catch (error) {
      console.error("Failed to initialize adapter:", error);
    }
  }
</script>

